<%#
	UU Booster View
-%>

<style>
	.uu-booster-container {
		padding: 20px;
		max-width: 600px;
		margin: 0 auto;
	}
	
	.uu-booster-status {
		background: #f5f5f5;
		padding: 15px;
		border-radius: 5px;
		margin-bottom: 20px;
	}
	
	.uu-booster-status.running {
		background: #d4edda;
		border-left: 4px solid #28a745;
	}
	
	.uu-booster-status.stopped {
		background: #f8d7da;
		border-left: 4px solid #dc3545;
	}
	
	.uu-booster-info {
		margin-bottom: 15px;
	}
	
	.uu-booster-info label {
		font-weight: bold;
		display: inline-block;
		width: 120px;
	}
	
	.uu-booster-info span {
		display: inline-block;
	}
	
	.uu-booster-actions {
		margin-top: 20px;
		padding-top: 20px;
		border-top: 1px solid #ddd;
	}
	
	.uu-booster-button {
		padding: 10px 20px;
		margin-right: 10px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-size: 14px;
	}
	
	.uu-booster-button.primary {
		background: #007bff;
		color: white;
	}
	
	.uu-booster-button.primary:hover {
		background: #0056b3;
	}
	
	.uu-booster-button:disabled {
		opacity: 0.5;
		cursor: not-allowed;
	}
	
	.uu-booster-message {
		margin-top: 15px;
		padding: 10px;
		border-radius: 4px;
		display: none;
	}
	
	.uu-booster-message.success {
		background: #d4edda;
		border: 1px solid #c3e6cb;
		color: #155724;
	}
	
	.uu-booster-message.error {
		background: #f8d7da;
		border: 1px solid #f5c6cb;
		color: #721c24;
	}
	
	.uu-booster-message.info {
		background: #d1ecf1;
		border: 1px solid #bee5eb;
		color: #0c5460;
	}
	
	.uu-booster-spinner {
		display: inline-block;
		width: 16px;
		height: 16px;
		margin-right: 8px;
		vertical-align: middle;
	}
</style>

<div class="uu-booster-container">
	<div class="uu-booster-status" id="service-status">
		<strong><%:Service Status:%></strong> <span id="status-text">Loading...</span>
	</div>
	
	<div class="uu-booster-info">
		<label><%:Current Version:%></label>
		<span id="current-version">Loading...</span>
	</div>
	
	<div class="uu-booster-info">
		<label><%:Latest Version:%></label>
		<span id="latest-version">Loading...</span>
	</div>
	
	<div class="uu-booster-actions">
		<button class="uu-booster-button primary" id="check-version-btn" onclick="checkVersion()">
			<%:Check for Updates%>
		</button>
		
		<button class="uu-booster-button primary" id="update-btn" onclick="updateBooster()" disabled>
			<%:Update to Latest%>
		</button>
		
		<button class="uu-booster-button" onclick="refreshStatus()">
			<%:Refresh Status%>
		</button>
		
		<button class="uu-booster-button" onclick="window.open('<%=url('admin/services/uu-booster/uu-update')%>', '_blank')">
			<%:Open Update CLI%>
		</button>
	</div>
	
	<div class="uu-booster-message" id="message-box"></div>
</div>

<script>
	function showMessage(message, type) {
		var messageBox = document.getElementById('message-box');
		messageBox.textContent = message;
		messageBox.className = 'uu-booster-message ' + type;
		messageBox.style.display = 'block';
		
		setTimeout(function() {
			messageBox.style.display = 'none';
		}, 5000);
	}
	
	function getStatusClass(status) {
		if (status && status.indexOf('running') >= 0) {
			return 'running';
		} else {
			return 'stopped';
		}
	}
	
	function refreshStatus() {
		var statusDiv = document.getElementById('service-status');
		var statusText = document.getElementById('status-text');
		
		XHR.get('<%=url('admin/services/uu-booster/status')%>', null,
			function(x, data) {
				statusDiv.className = 'uu-booster-status ' + getStatusClass(data.service_status);
				statusText.textContent = data.service_status;
				document.getElementById('current-version').textContent = data.current_version;
			},
			function(x) {
				showMessage('<%:Failed to get status%>', 'error');
			}
		);
	}
	
	function checkVersion() {
		var checkBtn = document.getElementById('check-version-btn');
		var updateBtn = document.getElementById('update-btn');
		
		checkBtn.disabled = true;
		checkBtn.innerHTML = '<span class="uu-booster-spinner"></span><%:Checking...%>';
		updateBtn.disabled = true;
		
		XHR.get('<%=url('admin/services/uu-booster/check_version')%>', null,
			function(x, data) {
				checkBtn.disabled = false;
				checkBtn.innerHTML = '<%:Check for Updates%>';
				
				if (data.success) {
					var latestSpan = document.getElementById('latest-version');
					latestSpan.textContent = data.latest_version;
					
					var currentSpan = document.getElementById('current-version');
					var currentVersion = currentSpan.textContent;
					
					if (currentVersion !== data.latest_version) {
						updateBtn.disabled = false;
						showMessage('<%:New version available!%>', 'info');
					} else {
						showMessage('<%:Already up to date%>', 'success');
					}
				} else {
					showMessage(data.error || '<%:Failed to check version%>', 'error');
				}
			},
			function(x) {
				checkBtn.disabled = false;
				checkBtn.innerHTML = '<%:Check for Updates%>';
				showMessage('<%:Failed to check version%>', 'error');
			}
		);
	}
	
	function updateBooster() {
		var updateBtn = document.getElementById('update-btn');
		
		updateBtn.disabled = true;
		updateBtn.innerHTML = '<span class="uu-booster-spinner"></span><%:Updating...%>';
		
		var md5CheckSpan = document.getElementById('md5-check');
		md5CheckSpan.textContent = '-';
		md5CheckSpan.className = 'uu-booster-message';
		
		var messageBox = document.getElementById('message-box');
		messageBox.style.display = 'none';
		
		XHR.post('<%=url('admin/services/uu-booster/uu-update')%>', null,
			function(x, data) {
				updateBtn.disabled = false;
				updateBtn.innerHTML = '<%:Update to Latest%>';
				
				if (data.success) {
					showMessage(data.message || '<%:Update completed successfully via uu-update script%>', 'success');
					
					setTimeout(function() {
						location.reload();
					}, 2000);
				} else {
					showMessage(data.message || '<%:Update failed%>', 'error');
					
					if (data.md5_check === 'failed') {
						md5CheckSpan.textContent = data.md5_check;
						md5CheckSpan.className = 'uu-booster-message ' + data.md5_check;
					}
				}
			},
			function(x) {
				updateBtn.disabled = false;
				updateBtn.innerHTML = '<%:Update to Latest%>';
				showMessage('<%:Update failed%>', 'error');
			}
		);
	}
	
	window.onload = function() {
		var currentVersionSpan = document.getElementById('current-version');
		var statusDiv = document.getElementById('service-status');
		var statusText = document.getElementById('status-text');
		
		currentVersionSpan.textContent = 'Loading...';
		
		XHR.get('<%=url('admin/services/uu-booster/status')%>', null,
			function(x, data) {
				if (data.current_version) {
					currentVersionSpan.textContent = data.current_version;
				} else {
					currentVersionSpan.textContent = 'Not installed';
				}
				
				if (data.service_status) {
					statusDiv.className = 'uu-booster-status ' + getStatusClass(data.service_status);
					statusText.textContent = data.service_status;
				} else {
					statusDiv.className = 'uu-booster-status stopped';
					statusText.textContent = 'Not running';
				}
			},
			function(x) {
				currentVersionSpan.textContent = 'Failed to load version';
				statusDiv.className = 'uu-booster-status stopped';
				statusText.textContent = 'Error';
			}
		);
	}
</script>
