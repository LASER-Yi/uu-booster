#!/bin/sh
UU_UPDATE_VERSION="1.0.1"

if [ -f /usr/lib/uu-common ]; then
	. /usr/lib/uu-common
else
	error_exit "Shared library /usr/lib/uu-common not found"
fi

stop_service() {
	if [ -f /etc/init.d/uu-booster ]; then
		info_message "Stopping uu-booster service..."
		/etc/init.d/uu-booster stop || true
	fi
}

start_service() {
	if [ -f /etc/init.d/uu-booster ]; then
		if /etc/init.d/uu-booster enabled 2>/dev/null; then
			info_message "Starting uu-booster service..."
			/etc/init.d/uu-booster start || true
		else
			echo ""
			echo "UU Booster service is disabled."
			echo "To enable and start the service, run:"
			echo "  /etc/init.d/uu-booster enable"
			echo "  /etc/init.d/uu-booster start"
			echo ""
		fi
	fi
}

restart_service() {
	stop_service
	start_service
}

main() {
	echo "========================================="
	echo "UU Booster Script v$UU_UPDATE_VERSION"
	echo "========================================="
	echo ""
	
	if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
		echo "Usage: $0 [command]"
		echo ""
		echo "Commands:"
		echo "  check    - Check for updates (display current and latest versions)"
		echo "  update    - Update to the latest version"
		echo "  status    - Show service status"
		echo "  restart   - Restart the service"
		echo "  help      - Show this help message"
		echo ""
		exit 0
	fi
	
	local arch=$(grep '^DISTRIB_ARCH' /etc/openwrt_release 2>/dev/null | awk -F "'" '{print $2}')
	
	if [ -z "$arch" ]; then
		error_exit "Failed to detect architecture from /etc/openwrt_release"
	fi
	
	local uu_arch=$(check_arch "$arch")
	
	if [ "$1" = "check" ]; then
		echo "Checking for updates..."
		echo ""
		echo "Current architecture: $arch"
		echo "UU architecture: $uu_arch"
		echo ""

		local installed_version=$(get_installed_version)
		if [ -n "$installed_version" ]; then
			echo "Current installed version: $installed_version"
		else
			echo "Current installed version: not installed"
		fi
		echo ""

		info_message "Querying UU API for $uu_arch..."

		local api_info=$(get_uu_api_info "$arch")

		if [ -z "$api_info" ]; then
			error_exit "Failed to get API information"
		fi

		local expected_md5=$(echo "$api_info" | cut -d'|' -f3)
		local download_url=$(echo "$api_info" | cut -d'|' -f1)

		if [ -z "$download_url" ]; then
			error_exit "Failed to extract download URL from API response"
		fi

		local installed_md5=$(get_installed_md5)

		if [ "$installed_md5" = "$expected_md5" ]; then
			echo "You already have the latest version installed."
			echo "No update needed."
		else
			echo "A new version is available!"
			echo ""
			echo "To install the latest version, run:"
			echo "  $0 update"
		fi
		echo ""
		exit 0
	fi
	
	if [ "$1" = "status" ]; then
		if [ -f /etc/init.d/uu-booster ]; then
			echo "Service status:"
			/etc/init.d/uu-booster status
		else
			echo "Service not installed"
		fi
		exit 0
	fi
	
	if [ "$1" = "restart" ]; then
		restart_service
		echo "Service restarted"
		exit 0
	fi
	
	if [ "$1" != "update" ]; then
		echo "Unknown command: $1"
		echo "Use '$0 --help' for usage information"
		exit 1
	fi

	echo "Updating UU Booster..."
	echo ""

	info_message "Querying UU API for $uu_arch..."

	local api_info=$(get_uu_api_info "$arch")

	if [ -z "$api_info" ]; then
		error_exit "Failed to get API information"
	fi

	local download_url=$(echo "$api_info" | cut -d'|' -f1)
	local download_url_bak=$(echo "$api_info" | cut -d'|' -f2)
	local expected_md5=$(echo "$api_info" | cut -d'|' -f3)

	if [ -z "$download_url" ]; then
		error_exit "Failed to extract download URL from API response"
	fi

	if [ -z "$expected_md5" ]; then
		info_message "MD5 validation not available, proceeding without checksum"
	fi

	mkdir -p "$UU_UPDATE_TEMP_DIR"

	local archive_file="$UU_UPDATE_TEMP_DIR/uu-booster.tar.gz"

	backup_uuid

	if download_file "$download_url" "$archive_file" "$expected_md5" "primary"; then
		info_message "Download successful from primary URL"
	else
		if [ -n "$download_url_bak" ]; then
			error_exit "Primary download failed and no backup URL available"
		else
			info_message "Primary URL failed, trying backup URL..."

			if download_file "$download_url_bak" "$archive_file" "$expected_md5" "backup"; then
				info_message "Download successful from backup URL"
			else
				error_exit "Both primary and backup downloads failed"
			fi
		fi
	fi
	
	if extract_archive "$archive_file"; then
		if install_files; then
			save_installed_md5 "$expected_md5"
			stop_service
			start_service
			
			echo ""
			echo "========================================="
			echo "Update completed successfully!"
			echo "========================================="
			echo ""
			if /etc/init.d/uu-booster enabled 2>/dev/null; then
				echo "Service has been restarted"
			else
				echo "Service is currently disabled"
				echo "To enable and start the service, run:"
				echo "  /etc/init.d/uu-booster enable"
				echo "  /etc/init.d/uu-booster start"
			fi
			echo ""
			exit 0
		else
			error_exit "Failed to install files"
		fi
	else
		error_exit "Failed to extract archive"
	fi
}

main "$@"
