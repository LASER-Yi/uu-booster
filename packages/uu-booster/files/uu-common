#!/bin/sh

UU_UPDATE_BINARY_DIR="/usr/sbin/uu"
UU_UPDATE_BINARY="uuplugin"
UU_UPDATE_TEMP_DIR="/tmp/uu-booster-update-$(date +%s)"

log_message() {
	logger -t uu -p daemon.info "$1"
	echo "$1"
}

error_exit() {
	log_message "ERROR: $1"
	exit 1
}

info_message() {
	log_message "INFO: $1"
}

cleanup() {
	if [ -d "$UU_UPDATE_TEMP_DIR" ]; then
		rm -rf "$UU_UPDATE_TEMP_DIR" 2>/dev/null
	fi
}

trap cleanup EXIT

backup_uuid() {
	if [ -f "$UU_UPDATE_BINARY_DIR/.uuplugin_uuid" ]; then
		mkdir -p /etc/uu
		cp "$UU_UPDATE_BINARY_DIR/.uuplugin_uuid" /etc/uu/.uuplugin_uuid
		info_message "UUID backed up to /etc/uu/.uuplugin_uuid"
	fi
}

restore_uuid() {
	if [ -f /etc/uu/.uuplugin_uuid ]; then
		mkdir -p "$UU_UPDATE_BINARY_DIR"
		cp /etc/uu/.uuplugin_uuid "$UU_UPDATE_BINARY_DIR/.uuplugin_uuid"
		info_message "UUID restored from /etc/uu/.uuplugin_uuid"
	fi
}

get_installed_version() {
	if [ -f "$UU_UPDATE_BINARY_DIR/uu.conf" ]; then
		grep '^version=' "$UU_UPDATE_BINARY_DIR/uu.conf" 2>/dev/null | cut -d'=' -f2
	else
		echo ""
	fi
}

get_installed_md5() {
	if [ -f "$UU_UPDATE_BINARY_DIR/.md5" ]; then
		cat "$UU_UPDATE_BINARY_DIR/.md5" 2>/dev/null
	else
		echo ""
	fi
}

save_installed_md5() {
	local md5="$1"
	echo "$md5" > "$UU_UPDATE_BINARY_DIR/.md5" 2>/dev/null
}

check_arch() {
	local arch=$1
	local uu_arch=""

	case "$arch" in
		aarch64_*)
			uu_arch="aarch64"
			;;
		arm_*)
			uu_arch="arm"
			;;
		mips_*)
			uu_arch="mipsel"
			;;
		x86_64)
			uu_arch="x86_64"
			;;
		*)
			error_exit "Unsupported architecture: $arch"
			;;
	esac

	echo "$uu_arch"
}

get_uu_api_info() {
	local arch=$1

	if [ -z "$arch" ]; then
		echo ""
		return 1
	fi

	local uu_arch=$(check_arch "$arch")

	if [ -z "$uu_arch" ]; then
		echo ""
		return 1
	fi

	local api_response=$(curl -s "http://router.uu.163.com/api/plugin?type=openwrt-$uu_arch" 2>/dev/null)

	if [ -z "$api_response" ]; then
		echo ""
		return 1
	fi

	local download_url=$(echo "$api_response" | sed -n 's/.*"url":"\([^"]*\)".*/\1/p' 2>/dev/null)
	local download_url_bak=$(echo "$api_response" | sed -n 's/.*"url_bak":"\([^"]*\)".*/\1/p' 2>/dev/null)
	local expected_md5=$(echo "$api_response" | sed -n 's/.*"md5":"\([^"]*\)".*/\1/p' 2>/dev/null)

	if [ -z "$download_url" ]; then
		echo ""
		return 1
	fi

	echo "$download_url|$download_url_bak|$expected_md5"
	return 0
}

download_file() {
	local url="$1"
	local output="$2"
	local expected_md5="$3"
	local attempt_name="$4"

	info_message "Download attempt $attempt_name: $url"

	wget -q -O "$output" "$url"

	if [ $? -ne 0 ]; then
		error_exit "Download failed (exit code: $?)"
	fi

	if [ ! -f "$output" ]; then
		error_exit "Downloaded file not found"
	fi

	local file_size=$(wc -c "$output" 2>/dev/null | awk '{print $1}')
	if [ -z "$file_size" ] || [ "$file_size" -lt 1024 ]; then
		error_exit "Downloaded file too small (${file_size:-0} bytes), possibly error page"
	fi

	info_message "Downloaded file size: $file_size bytes"

	if [ -n "$expected_md5" ] && [ "$expected_md5" != "none" ]; then
		local calculated_md5=$(md5sum "$output" | awk '{print $1}')

		if [ -z "$calculated_md5" ]; then
			error_exit "Failed to calculate MD5 checksum"
		fi

		info_message "MD5 Check:"
		info_message "  Expected: $expected_md5"
		info_message "  Calculated: $calculated_md5"

		if [ "$calculated_md5" = "$expected_md5" ]; then
			info_message "MD5 checksum: OK"
		else
			error_exit "MD5 checksum mismatch!"
		fi
	else
		info_message "MD5 validation skipped (no expected MD5 provided)"
	fi

	return 0
}

extract_archive() {
	local archive="$1"
	local extract_dir="$UU_UPDATE_TEMP_DIR/extracted"

	info_message "Extracting archive: $archive"

	mkdir -p "$extract_dir"

	tar -xzf "$archive" -C "$extract_dir"

	if [ $? -ne 0 ]; then
		error_exit "Failed to extract archive"
	fi

	return 0
}

install_files() {
	local extract_dir="$UU_UPDATE_TEMP_DIR/extracted"

	info_message "Installing files to $UU_UPDATE_BINARY_DIR"

	mkdir -p "$UU_UPDATE_BINARY_DIR"

	cp -r "$extract_dir"/* "$UU_UPDATE_BINARY_DIR/"

	if [ $? -ne 0 ]; then
		error_exit "Failed to copy files"
	fi

	chmod +x "$UU_UPDATE_BINARY_DIR/$UU_UPDATE_BINARY"
	restore_uuid

	info_message "Files installed successfully"
}
